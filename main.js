(()=>{"use strict";function t(){return new Promise((t,e)=>{navigator.geolocation.getCurrentPosition(e=>{const{latitude:s,longitude:n}=e.coords;t({latitude:s,longitude:n})},t=>{e(t)})})}function e(t,e,s,n){const o=new Date,{latitude:i,longitude:a}=e,r=document.createElement("div");r.classList.add("message-item");const d=document.createElement("p");let c;d.classList.add("message-date"),d.textContent=o.toLocaleString(),"text"===s&&(c=document.createElement("p"),c.classList.add("text-message"),c.textContent=t),"audio"===s&&(c=document.createElement("audio"),c.classList.add("audio-message"),c.controls=!0,c.src=n),"video"===s&&(c=document.createElement("audio"),c.classList.add("video-message"),c.srcObject=n);const l=document.createElement("p");return l.classList.add("message-location"),l.textContent=`[${i}, ${a}]`,r.append(d,c,l),r}class s{constructor(t,e){this.container=t,this.onCoordinatesValidated=e,this.onSendLocation=this.onSendLocation.bind(this),this.renderForm()}renderForm(){const t=document.createElement("form");t.classList.add("location-form");const e=document.createElement("p");e.classList.add("form-title"),e.textContent="Что-то пошло не так...";const s=document.createElement("p");s.classList.add("form-text"),s.textContent="К сожалению, нам не удалось определить ваше местоположение, пожалуйста, дайте разрешение на использование геолокации, либо введите координаты вручную.";const n=document.createElement("label");n.classList.add("form-label"),n.textContent="Широта и долгота через запятую",this.formInput=document.createElement("input"),this.formInput.classList.add("form-input"),this.formInput.type="text",n.appendChild(this.formInput);const o=document.createElement("div");o.classList.add("button-wrapper");const i=document.createElement("button");i.classList.add("cancel-button"),i.textContent="Отмена",i.addEventListener("click",this.closeForm);const a=document.createElement("input");a.classList.add("send-button"),a.textContent="Ок",a.type="submit",o.append(i,a),t.append(e,s,n,o),t.addEventListener("submit",this.onSendLocation),this.container.append(t)}onSendLocation(t){t.preventDefault();const e=function(t){if(!/^-?\d+(\.\d+)?\s*,\s*-?\d+(\.\d+)?$/.test(t))return alert("Введите координаты в формате: широта, долгота"),null;const[e,s]=t.split(",").map(t=>t.trim()),n=parseFloat(e),o=parseFloat(s);return n>=-90&&n<=90&&o>=-180&&o<=180?{latitude:n,longitude:o}:(alert("Широта должна быть от -90 до 90, долгота — от -180 до 180"),null)}(this.formInput.value.trim());if(!e)return;const{latitude:s,longitude:n}=e;this.onCoordinatesValidated({latitude:s,longitude:n}),t.target.remove()}closeForm(t){t.target.closest("form").remove()}}class n{constructor(t){this.element=t,this.time=0,this.interval=null}start(){this.interval||(this.interval=setInterval(()=>{this.time++,this.updateTime()},1e3))}stop(){clearInterval(this.interval),this.time=0,this.interval=null,this.element.textContent="00:00"}updateTime(){const t=Math.floor(this.time/60),e=this.time%60,s=`${String(t).padStart(2,"0")}:${String(e).padStart(2,"0")}`;this.element.textContent=s}}class o{constructor(t){this.onAudioReady=t,this.onVoiceButton=this.onVoiceButton.bind(this),this.onCameraButton=this.onCameraButton.bind(this),this.media=null,this.recorder=null,this.chunks=[],this.isCanceled=!1}renderForm(){const t=document.createElement("form");t.classList.add("message-form");const e=document.createElement("input");e.classList.add("message-input"),e.type="text",e.name="message";const s=document.createElement("div");s.classList.add("recorder-button-wrapper"),this.recorderButtonWrapper=s;const o=document.createElement("button");o.type="button",o.classList.add("voice-button"),o.addEventListener("click",this.onVoiceButton);const i=document.createElement("button");i.type="button",i.classList.add("camera-button");const a=document.createElement("div");a.classList.add("recorder-block","hidden"),this.recorderBlock=a;const r=document.createElement("button");r.type="button",r.classList.add("stop-record-button"),this.stopRecordButton=r;const d=document.createElement("div");d.classList.add("stopwatch"),d.textContent="00:00",this.stopwatch=d;const c=document.createElement("button");return c.type="button",c.classList.add("cancel-record-button"),this.cancelRecordButton=c,a.append(r,d,c),i.addEventListener("click",this.onCameraButton),s.append(o,i),t.append(e,s,a),this.onStopwatch=new n(this.stopwatch),t}async onVoiceButton(){this.isCanceled=!1,this.showRecorderBlock(),this.onStopwatch.start(),this.media=await navigator.mediaDevices.getUserMedia({audio:!0}),this.recorder=new MediaRecorder(this.media),this.chunks=[],this.cancelRecordButton.addEventListener("click",()=>{this.cancelRecording()}),this.recorder.addEventListener("dataavailable",t=>{this.chunks.push(t.data)}),this.recorder.addEventListener("stop",()=>{if(!this.chunks.length||this.isCanceled)return;const t=new Blob(this.chunks),e=URL.createObjectURL(t);this.onAudioReady&&this.onAudioReady(e),this.stopMediaStream(),this.hideRecorderBlock()}),this.recorder.start(),this.stopRecordButton.addEventListener("click",()=>{this.recorder.stop(),this.onStopwatch.stop()})}cancelRecording(){this.isCanceled=!0,this.recorder&&"inactive"!==this.recorder.state&&this.recorder.stop(),this.chunks=[],this.stopMediaStream(),this.hideRecorderBlock(),this.onStopwatch.stop()}stopMediaStream(){this.media&&(this.media.getTracks().forEach(t=>t.stop()),this.media=null)}showRecordTime(){}onCameraButton(){console.log("camera")}showRecorderBlock(){this.recorderButtonWrapper.classList.add("hidden"),this.recorderBlock.classList.remove("hidden")}hideRecorderBlock(){this.recorderButtonWrapper.classList.remove("hidden"),this.recorderBlock.classList.add("hidden")}}const i=document.getElementById("root");new class{constructor(t){if(!(t instanceof HTMLElement))throw new Error("This is not HTML element!");this.container=t,this.sendMessage=this.sendMessage.bind(this),this.manualCoords=null,this.init()}init(){this.renderTimeline()}renderTimeline(){const t=document.createElement("div");t.classList.add("timeline-block");const e=document.createElement("div");e.classList.add("message-block"),this.messageBlock=e;const s=new o(t=>{this.sendAudioMessage(t)}).renderForm();t.append(e,s),this.container.appendChild(t),s.addEventListener("submit",this.sendMessage)}async sendMessage(n){let o;n.preventDefault();try{o=await t()}catch(t){if(this.container.querySelector(".location-form"))return;if(!this.manualCoords)return void new s(this.container,t=>{this.manualCoords=t,this.sendMessage(n)});o=this.manualCoords}const i=n.target.elements.message.value;if(!i)return;const a=e(i,o,"text");this.messageBlock.appendChild(a),n.target.reset()}async sendAudioMessage(n){let o;try{o=await t()}catch(t){if(!this.manualCoords)return void new s(this.container,t=>{this.manualCoords=t,this.sendAudioMessage(n)});o=this.manualCoords}const i=e(null,o,"audio",n);this.messageBlock.appendChild(i)}}(i)})();